version: 2
jobs:
  test:
    docker:
      - image: edbizarro/gitlab-ci-pipeline-php:7.2
    working_directory: /var/www/html
    steps:
      - checkout
      - restore_cache:
          keys:
            - vendor-{{ checksum "composer.json" }}
      - run: composer update --no-interaction --no-progress --prefer-dist --optimize-autoloader --ignore-platform-reqs
      - save_cache:
          paths:
            - ./vendor
          key: vendor-{{ checksum "composer.json" }}      
      - run: php artisan config:cache
      - run: cp .env.testing .env
      - run: touch storage/test.sqlite ; chmod -R 777 storage
      - run: php artisan migrate --seed --env=testing --force
      - run: ./vendor/bin/phpunit
      - store_test_results:
          path: tests/_output
workflows:
  version: 2 
  deploy:
    jobs:
      - test